<!DOCTYPE html>
<html lang="pt-PT" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadro Vivo - Master Edition v2.0</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- 1. THEME & VARIABLES --- */
        :root {
            --bg-grad-1: #0f2027;
            --bg-grad-2: #203a43;
            --bg-grad-3: #2c5364;
            --text-color: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-hover: rgba(255, 255, 255, 0.2);
            --accent-color: #4facfe;
            --danger-color: #ff6b6b;
            --success-color: #51cf66;
            --warn-color: #fcc419;
            --clap-color: #d63384;
            --gold-color: #ffd700;
            --font-main: 'Montserrat', sans-serif;
            --font-size-base: 5rem;
            --modal-overlay: rgba(0, 0, 0, 0.6);
        }

        [data-theme="light"] {
            --bg-grad-1: #dfe9f3;
            --bg-grad-2: #ffffff;
            --bg-grad-3: #fdfbfb;
            --text-color: #1a1a1a;
            --glass-bg: rgba(0, 0, 0, 0.04);
            --glass-border: rgba(0, 0, 0, 0.08);
            --glass-hover: rgba(0, 0, 0, 0.08);
            --accent-color: #005bea;
            --modal-overlay: rgba(255, 255, 255, 0.6);
        }

        /* --- 2. RESET & BASE --- */
        * {
            box-sizing: border-box;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: var(--font-main);
            color: var(--text-color);
            transition: color 0.5s ease;
            user-select: none;
        }

        /* Animated Background */
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(-45deg, var(--bg-grad-1), var(--bg-grad-2), var(--bg-grad-3));
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            z-index: -2;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .visible {
            opacity: 1 !important;
            transform: translateY(0) scale(1) !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus Management */
        button:focus-visible,
        input:focus-visible,
        textarea:focus-visible {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* --- 3. LAYOUT COMPONENTS --- */

        /* Logo & Menu */
        #logo-area {
            position: absolute;
            top: 30px;
            left: 40px;
            z-index: 200;
        }

        #logo-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.9;
            transition: opacity 0.2s;
            padding: 5px;
            border-radius: 8px;
        }

        #logo-btn:hover {
            opacity: 1;
            background: var(--glass-hover);
        }

        #app-logo {
            height: 90px;
            width: auto;
            object-fit: contain;
            pointer-events: none;
        }

        #logo-arrow {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.5;
            transition: transform 0.3s;
        }

        #logo-area.active #logo-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 10px;
            width: 260px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 2px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: fadeInMenu 0.2s ease-out;
        }

        #logo-area.active .dropdown-menu {
            display: flex;
        }

        @keyframes fadeInMenu {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .menu-category {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.5;
            padding: 8px 10px 4px;
            margin-top: 5px;
        }

        .menu-item {
            padding: 10px 15px;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            opacity: 0.9;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .menu-item:hover {
            background: var(--glass-hover);
            opacity: 1;
        }

        .menu-item.active {
            background: var(--glass-hover);
            opacity: 1;
            font-weight: 600;
        }

        .menu-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid currentColor;
            opacity: 0.5;
            background: transparent;
        }

        .menu-item.active .menu-dot {
            background: var(--accent-color);
            border-color: var(--accent-color);
            opacity: 1;
        }

        .menu-divider {
            height: 1px;
            background: var(--glass-border);
            margin: 6px 0;
            opacity: 0.5;
        }

        /* Main Display Area */
        #display-area {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 5%;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-size: var(--font-size-base);
            font-weight: 800;
            line-height: 1.1;
            margin: 0;
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            transition: font-size 0.3s ease, opacity 0.5s, transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        /* Navigation Arrows */
        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 70px;
            height: 70px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 90;
            transition: all 0.3s;
            opacity: 0;
            pointer-events: none;
            backdrop-filter: blur(5px);
            color: var(--text-color);
        }

        .nav-arrow.visible {
            opacity: 0.6;
            pointer-events: all;
        }

        .nav-arrow:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.15);
            background: var(--glass-hover);
        }

        .nav-arrow.left {
            left: 30px;
        }

        .nav-arrow.right {
            right: 30px;
        }

        .nav-arrow svg {
            width: 32px;
            height: 32px;
            stroke: currentColor;
            stroke-width: 2.5;
            fill: none;
        }

        .nav-queue-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* --- 4. CONTROL PANEL --- */
        #control-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 75%;
            max-width: 900px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 15px;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.7;
            z-index: 100;
        }

        #control-panel.expanded {
            border-radius: 20px;
            padding: 20px;
            background: rgba(15, 32, 39, 0.95);
        }

        #control-panel:hover,
        #control-panel:focus-within,
        #control-panel.drawer-open {
            opacity: 1;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* Toolbar */
        #toolbar {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        #rich-toolbar {
            display: none;
            gap: 5px;
            width: 100%;
            justify-content: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
            animation: fadeInMenu 0.3s ease;
        }

        #control-panel.expanded #rich-toolbar {
            display: flex;
        }

        .fmt-btn {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .fmt-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .submenu-close {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-color);
            opacity: 0.5;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }

        .submenu-close:hover {
            opacity: 1;
            color: var(--danger-color);
        }

        .fmt-btn:hover {
            background: var(--glass-hover);
            opacity: 1;
        }

        #control-panel:focus-within #toolbar,
        #control-panel.expanded #toolbar,
        #control-panel.drawer-open #toolbar {
            max-height: 120px;
            opacity: 1;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        .tool-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.8;
        }

        .tool-btn:hover,
        .tool-btn:focus,
        .tool-btn.active {
            background: var(--glass-hover);
            border-color: var(--glass-border);
            opacity: 1;
            transform: translateY(-1px);
        }

        .tool-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            pointer-events: none;
        }

        .separator {
            width: 1px;
            background: var(--glass-border);
            height: 24px;
            margin: 0 5px;
        }

        /* Sound Drawer */
        #sound-drawer {
            width: 100%;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            margin-bottom: 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }

        #sound-drawer.open {
            max-height: 250px;
            opacity: 1;
            margin-bottom: 15px;
            padding-bottom: 15px;
            padding-right: 30px;
            /* Space for close btn */
            border-bottom: 1px solid var(--glass-border);
        }

        #sound-drawer .submenu-close {
            top: 10px;
            transform: none;
        }

        .tool-btn.sound-playing {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--text-color);
            opacity: 1;
            animation: pulseEffect 0.5s infinite alternate;
        }

        @keyframes pulseEffect {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.05);
            }
        }

        /* Input Area */
        .input-wrapper {
            width: 100%;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            position: relative;
        }

        .input-editor {
            flex-grow: 1;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 1.1rem;
            outline: none;
            font-family: inherit;
            text-align: left;
            min-height: 40px;
            max-height: 40px;
            transition: all 0.3s ease;
            overflow-y: hidden;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        #control-panel.expanded .input-editor {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .input-editor[placeholder]:empty:before {
            content: attr(placeholder);
            color: rgba(150, 150, 150, 0.7);
        }

        #btn-send {
            display: none;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        #control-panel.expanded #btn-send {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #btn-send:hover {
            transform: scale(1.1);
        }

        #queue-info-badge {
            position: absolute;
            right: 0;
            bottom: 45px;
            background: var(--accent-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #queue-info-badge.visible {
            opacity: 1;
        }

        /* --- 5. SPECIAL VIEWS (MODALS/COMPONENTS) --- */

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .glass-modal {
            background: #1a2b33;
            /* Fallback */
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: var(--text-color);
        }

        .modal-overlay.open .glass-modal {
            transform: translateY(0) scale(1);
        }

        .modal-header h2 {
            margin: 0 0 15px 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            margin-top: 10px;
        }

        .modal-input:focus {
            outline: 2px solid var(--accent-color);
            border-color: transparent;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-cancel {
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--glass-border);
        }

        .btn-cancel:hover {
            background: var(--glass-hover);
        }

        .btn-confirm {
            background: var(--accent-color);
            color: white;
        }

        .btn-confirm:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        /* QR Code Container */
        #qr-container {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: none;
            position: relative;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        #qr-close {
            position: absolute;
            top: -15px;
            right: -15px;
            background: var(--danger-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        #qr-close:hover {
            transform: scale(1.1);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Timer Overlay */
        #timer-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 4rem;
            /* Increased size */
            font-weight: 300;
            background: var(--glass-bg);
            padding: 15px 35px;
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
            display: none;
            z-index: 100;
            font-variant-numeric: tabular-nums;
        }

        /* Scoreboard */
        #scoreboard {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 50;
            display: none;
            flex-wrap: wrap;
            justify-content: center;
        }

        .score-team {
            text-align: center;
            background: var(--glass-bg);
            padding: 10px 20px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: transform 0.2s, border 0.3s;
            min-width: 90px;
            user-select: none;
        }

        .score-team:hover {
            transform: scale(1.05);
            background: var(--glass-hover);
        }

        .score-val {
            font-size: 4rem;
            /* Increased size */
            font-weight: 700;
            line-height: 1;
        }

        .score-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        .score-team.winner-highlight {
            transform: scale(1.15);
            border: 2px solid var(--gold-color);
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        /* Dice */
        .dice-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .dice-result {
            font-size: 4rem;
            font-weight: 800;
            color: var(--accent-color);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s;
        }

        .dice-result.show {
            opacity: 1;
            transform: translateY(0);
        }

        .dice-visuals {
            display: flex;
            gap: 30px;
            font-size: 10rem;
            line-height: 1;
            text-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .dice-shake {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tool-btn span {
                display: none;
            }

            .tool-btn {
                padding: 10px;
            }

            h1 {
                font-size: 3rem !important;
            }

            #logo-area {
                top: 15px;
                left: 15px;
            }

            #control-panel {
                width: 95%;
                bottom: 15px;
            }
        }
    </style>
</head>

<body data-mode="pro">

    <div class="background"></div>

    <!-- HEADER: Logo & Menu -->
    <header id="logo-area">
        <button id="logo-btn" onclick="toggleMenu(event)" aria-label="Abrir Menu de Tema" aria-haspopup="true">
            <img id="app-logo" src="" alt="Logo">
            <span id="logo-arrow">▼</span>
        </button>

        <div id="style-menu" class="dropdown-menu" role="menu">
            <div class="menu-category">Projeto / Identidade</div>
            <button class="menu-item" onclick="app.setBrand('futuro')" id="brand-futuro" role="menuitem">
                <div class="menu-dot"></div> Futuro Digital
            </button>
            <button class="menu-item" onclick="app.setBrand('passaporte')" id="brand-passaporte" role="menuitem">
                <div class="menu-dot"></div> Passaporte Competências
            </button>
            <button class="menu-item" onclick="app.setBrand('ia')" id="brand-ia" role="menuitem">
                <div class="menu-dot"></div> IA para Todos
            </button>

            <div class="menu-divider"></div>
            <div class="menu-category">Modo & Tema</div>
            <button class="menu-item" onclick="app.setMode('pro')" id="mode-pro" role="menuitem">
                <div class="menu-dot"></div> Pro (Completo)
            </button>
            <button class="menu-item" onclick="app.setMode('simple')" id="mode-simple" role="menuitem">
                <div class="menu-dot"></div> Zen (Simples)
            </button>
            <div class="menu-divider"></div>
            <button class="menu-item" onclick="app.setTheme('dark')" id="theme-dark" role="menuitem">
                <div class="menu-dot"></div> Escuro
            </button>
            <button class="menu-item" onclick="app.setTheme('light')" id="theme-light" role="menuitem">
                <div class="menu-dot"></div> Claro
            </button>
        </div>
    </header>

    <!-- NAVIGATION -->
    <button id="nav-left" class="nav-arrow left" onclick="app.navHistory('back')" aria-label="Recuar no Histórico">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="m15 18-6-6 6-6" />
        </svg>
    </button>
    <button id="nav-right" class="nav-arrow right" onclick="app.navHistory('fwd')"
        aria-label="Avançar (Fila ou Histórico)">
        <div id="nav-queue-count" class="nav-queue-badge hidden">0</div>
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6" />
        </svg>
    </button>

    <!-- OVERLAYS -->
    <div id="scoreboard"></div>
    <div id="timer-overlay">00:00</div>

    <!-- MAIN CONTENT -->
    <main id="display-area" aria-live="polite">
        <h1 id="main-text"></h1>
        <div id="qr-container">
            <button id="qr-close" onclick="ui.closeQR()" aria-label="Fechar QR Code">×</button>
            <div id="qr-canvas-wrapper"></div>
        </div>
    </main>

    <!-- FOOTER: Control Panel -->
    <footer id="control-panel">
        <div id="toolbar">
            <button class="tool-btn" onclick="ui.toggleExpand()" title="Modo Lista/Texto Longo">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="21" y1="10" x2="3" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="21" y1="18" x2="3" y2="18"></line>
                </svg>
            </button>
            <div class="separator"></div>

            <button class="tool-btn" onclick="features.timer.setup()" title="Definir tempo">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>Timer</span>
            </button>

            <button class="tool-btn" onclick="features.score.setup()" title="Placar">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                    <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                    <path d="M4 22h16"></path>
                    <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                    <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                    <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                </svg>
                <span>Placar</span>
            </button> <!-- Fixed closing tag -->

            <div class="separator"></div>

            <button class="tool-btn" onclick="features.dice.roll()" title="Gerar Dados">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                    <path d="M16 8h.01"></path>
                    <path d="M8 8h.01"></path>
                    <path d="M8 16h.01"></path>
                    <path d="M16 16h.01"></path>
                    <path d="M12 12h.01"></path>
                </svg>
                <span>Dados</span>
            </button>
            <button class="tool-btn" onclick="features.picker.setup()" title="Sortear Nome">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M20.42 4.58a5.4 5.4 0 0 0-7.65 0l-.77.78-.77-.78a5.4 5.4 0 0 0-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z">
                    </path>
                </svg>
                <span>Sorteio</span>
            </button>

            <div class="separator"></div>

            <button id="btn-sound-drawer" class="tool-btn" onclick="ui.toggleSoundDrawer()" title="Sons">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
                <span>Sons</span>
            </button>

            <button class="tool-btn" onclick="ui.toggleQR()" title="Criar QR Code">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="5" height="5" x="3" y="3" rx="1"></rect>
                    <rect width="5" height="5" x="16" y="3" rx="1"></rect>
                    <rect width="5" height="5" x="3" y="16" rx="1"></rect>
                    <path d="M21 16h-3a2 2 0 0 0-2 2v3"></path>
                    <path d="M21 21v.01"></path>
                    <path d="M12 7v3a2 2 0 0 1-2 2H7"></path>
                    <path d="M3 12h.01"></path>
                    <path d="M12 3h.01"></path>
                    <path d="M12 16v.01"></path>
                    <path d="M16 12h1"></path>
                    <path d="M21 12v.01"></path>
                    <path d="M12 21v-1"></path>
                </svg>
            </button>

            <div class="separator"></div>

            <button class="tool-btn" onclick="app.clear()" title="Limpar Ecrã">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
            </button>
        </div>

        <div id="rich-toolbar">
            <button class="submenu-close" onclick="ui.toggleExpand()" title="Fechar">×</button>
            <button class="fmt-btn" onmousedown="event.preventDefault(); document.execCommand('bold', false, null)"
                title="Negrito"><b>B</b></button>
            <button class="fmt-btn" onmousedown="event.preventDefault(); document.execCommand('italic', false, null)"
                title="Itálico"><i>I</i></button>
            <button class="fmt-btn" onmousedown="event.preventDefault(); document.execCommand('underline', false, null)"
                title="Sublinhado"><u>U</u></button>
            <div class="separator" style="height: 16px;"></div>
            <button class="fmt-btn"
                onmousedown="event.preventDefault(); document.execCommand('insertUnorderedList', false, null)"
                title="Lista">
                <svg viewBox="0 0 24 24">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
            </button>
            <button class="fmt-btn"
                onmousedown="event.preventDefault(); document.execCommand('insertOrderedList', false, null)"
                title="Numeração">
                <svg viewBox="0 0 24 24">
                    <line x1="10" y1="6" x2="21" y2="6"></line>
                    <line x1="10" y1="12" x2="21" y2="12"></line>
                    <line x1="10" y1="18" x2="21" y2="18"></line>
                    <path d="M4 6h1v4"></path>
                    <path d="M4 10h2"></path>
                    <path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"></path>
                </svg>
            </button>
            <div class="separator" style="height: 16px;"></div>
            <button class="fmt-btn"
                onmousedown="event.preventDefault(); document.execCommand('justifyLeft', false, null)" title="Esquerda">
                <svg viewBox="0 0 24 24">
                    <line x1="17" y1="10" x2="3" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="17" y1="18" x2="3" y2="18"></line>
                </svg>
            </button>
            <button class="fmt-btn"
                onmousedown="event.preventDefault(); document.execCommand('justifyCenter', false, null)" title="Centro">
                <svg viewBox="0 0 24 24">
                    <line x1="21" y1="10" x2="3" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="21" y1="18" x2="3" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- SOUND DRAWER -->
        <div id="sound-drawer">
            <!-- Dynamically populated via JS -->
            <button class="submenu-close" onclick="ui.toggleSoundDrawer()" title="Fechar">×</button>
        </div>

        <div class="input-wrapper">
            <div id="input-text" class="input-editor" contenteditable="true"
                placeholder="Escreva... (Shift+Enter para Fila)" spellcheck="false"></div>
            <button id="btn-send" onclick="app.manualSubmit()" title="Projetar (Ctrl+Enter)"
                aria-label="Projetar Texto">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
            <div id="queue-info-badge">0 na Fila</div>
        </div>
    </footer>

    <!-- MODAL SYSTEM CONTAINER -->
    <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
        <div class="glass-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-header">
                <h2 id="modal-title">Título</h2>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Content injected here -->
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="modal-cancel">Cancelar</button>
                <button class="modal-btn btn-confirm" id="modal-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        /*******************************************************
         * 1. CONSTANTS & ASSETS
         *******************************************************/
        const BRANDS = {
            'futuro': { light: 'https://i.imgur.com/L7wNgqt.png', dark: 'https://i.imgur.com/9IkzQXi.png', name: 'Futuro Digital' },
            'passaporte': { light: 'https://i.imgur.com/Rzf5kQ3.png', dark: 'https://i.imgur.com/Mzwq7n0.png', name: 'Passaporte Competências' },
            'ia': { light: 'https://i.imgur.com/9qGRGAt.png', dark: 'https://i.imgur.com/QPifhum.png', name: 'IA para Todos' }
        };

        const SOUNDS = {
            success: "https://heldertoucas.github.io/quadrobrancoformador/certo.mp3",
            error: "https://heldertoucas.github.io/quadrobrancoformador/errado.mp3",
            pointUp: "https://heldertoucas.github.io/quadrobrancoformador/mais_um_ponto.mp3",
            pointDown: "https://heldertoucas.github.io/quadrobrancoformador/menos_um_ponto.mp3",
            drum: "https://heldertoucas.github.io/quadrobrancoformador/rufar.mp3",
            clap: "https://heldertoucas.github.io/quadrobrancoformador/aplausos.mp3",
            palmas: "https://heldertoucas.github.io/quadrobrancoformador/palmas.mp3",
            fanfare: "https://heldertoucas.github.io/quadrobrancoformador/trompetas.mp3",
            trophy: "https://heldertoucas.github.io/quadrobrancoformador/sucesso_guitarra.mp3"
        };

        const SOUND_METADATA = [
            { id: 'success', color: 'var(--success-color)', icon: 'Check', label: 'Sucesso' },
            { id: 'error', color: 'var(--danger-color)', icon: 'X', label: 'Erro' },
            { id: 'drum', color: 'var(--warn-color)', icon: 'Drum', label: 'Tambores' },
            { id: 'clap', color: 'var(--clap-color)', icon: 'Clap', label: 'Aplauso' },
            { id: 'palmas', color: 'var(--clap-color)', icon: 'Clap', label: 'Palmas' },
            { id: 'pointUp', color: 'var(--success-color)', icon: 'Plus', label: '+1' },
            { id: 'pointDown', color: 'var(--danger-color)', icon: 'Minus', label: '-1' },
            { id: 'fanfare', color: 'var(--warn-color)', icon: 'Speaker', label: 'Fanfarra' },
            { id: 'trophy', color: 'var(--gold-color)', icon: 'Trophy', label: 'Vitória' }
        ];

        /* Helper for SVG Icons */
        const ICONS = {
            Check: '<polyline points="22 4 12 14.01 9 11.01"></polyline><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>',
            X: '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>',
            Drum: '<path d="M12 2c5.5 0 10 1.8 10 4s-4.5 4-10 4S2 8.2 2 6s4.5-4 10-4z"></path><path d="M22 6v8c0 2.2-4.5 4-10 4S2 16.2 2 14V6"></path>',
            Clap: '<path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"></path><path d="M18 9h2a2 2 0 0 1 2 2v11l-4-4h-6a2 2 0 0 1-2-2v-1"></path>',
            Plus: '<path d="M12 5v14"></path><path d="M5 12h14"></path>',
            Minus: '<path d="M5 12h14"></path>',
            Speaker: '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>',
            Trophy: '<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>'
        };

        /*******************************************************
         * 2. STATE MANAGEMENT
         *******************************************************/
        const state = {
            queue: [], history: [], historyIndex: -1,
            timerInterval: null,
            theme: localStorage.getItem('qv_theme') || 'dark',
            mode: localStorage.getItem('qv_mode') || 'pro',
            brand: localStorage.getItem('qv_brand') || 'futuro',
            isExpanded: false,
            scores: {},
            audioCtx: null, activeSounds: {}
        };

        /*******************************************************
         * 3. SERVICES (Audio, Modal)
         *******************************************************/

        class AudioService {
            static init() {
                if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }

            static toggle(key) {
                this.init();
                // Stop if playing
                if (state.activeSounds[key]) {
                    const sound = state.activeSounds[key];
                    if (sound.audio) { sound.audio.pause(); sound.audio.currentTime = 0; }
                    delete state.activeSounds[key];
                    ui.highlightSound(key, false);
                    return;
                }

                // Play
                const url = SOUNDS[key];
                const isLoop = ['drum', 'clap', 'palmas'].includes(key);

                if (url) {
                    const audio = new Audio(url);
                    audio.loop = isLoop;
                    state.activeSounds[key] = { audio };
                    ui.highlightSound(key, true);

                    if (!isLoop) audio.onended = () => {
                        delete state.activeSounds[key];
                        ui.highlightSound(key, false);
                    };

                    audio.play().catch(() => this.playSynth(key));
                } else {
                    this.playSynth(key);
                }

                if (['fanfare', 'trophy'].includes(key)) ui.confetti();
            }

            static playSynth(key) {
                // Fallback synthesis logic can be kept simple here
                // (Omitted for brevity, but kept structure if needed)
                console.warn("Audio fallback triggered for", key);
            }
        }

        class ModalSystem {
            constructor() {
                this.overlay = document.getElementById('modal-overlay');
                this.title = document.getElementById('modal-title');
                this.body = document.getElementById('modal-body');
                this.btnConfirm = document.getElementById('modal-confirm');
                this.btnCancel = document.getElementById('modal-cancel');

                this.btnCancel.onclick = () => this.close();
                this.resolvePromise = null;
            }

            show({ title, html, confirmText = 'Confirmar', showCancel = true }) {
                this.title.innerText = title;
                this.body.innerHTML = html;
                this.btnConfirm.innerText = confirmText;
                this.btnCancel.style.display = showCancel ? 'block' : 'none';
                this.overlay.classList.add('open');
                this.overlay.setAttribute('aria-hidden', 'false');

                // Focus trap logic could be added here
                const input = this.body.querySelector('input');
                if (input) input.focus();
                else this.btnConfirm.focus();

                return new Promise((resolve) => {
                    this.resolvePromise = resolve;
                    this.btnConfirm.onclick = () => {
                        const val = input ? input.value : true;
                        this.close();
                        resolve(val);
                    };
                    // Extend cancel to resolve false/null
                    this.btnCancel.onclick = () => {
                        this.close();
                        resolve(null);
                    };
                });
            }

            close() {
                this.overlay.classList.remove('open');
                this.overlay.setAttribute('aria-hidden', 'true');
            }
        }
        const modal = new ModalSystem();

        /*******************************************************
         * 4. UI CONTROLLER
         *******************************************************/
        const ui = {
            els: {
                mainText: document.getElementById('main-text'),
                qrContainer: document.getElementById('qr-container'),
                qrWrapper: document.getElementById('qr-canvas-wrapper'),
                input: document.getElementById('input-text'),
                root: document.documentElement
            },

            init() {
                this.renderSoundDrawer();
                this.applyState();

                // Event Listeners
                document.addEventListener('click', (e) => {
                    if (!document.getElementById('logo-area').contains(e.target)) {
                        document.getElementById('logo-area').classList.remove('active');
                    }
                });

                this.els.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey && !state.isExpanded) {
                        e.preventDefault();
                        app.processInput();
                    }
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        app.manualSubmit();
                    }
                    if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        app.addToQueue();
                    }
                });
            },

            renderSoundDrawer() {
                const drawer = document.getElementById('sound-drawer');
                drawer.innerHTML = '<button class="submenu-close" onclick="ui.toggleSoundDrawer()" title="Fechar">×</button>' +
                    SOUND_METADATA.map(s => `
                    <button id="btn-${s.id}" class="tool-btn sound-drawer-btn" onclick="AudioService.toggle('${s.id}')" title="${s.label}">
                        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" style="stroke:${s.color}">${ICONS[s.icon]}</svg>
                        <span>${s.label}</span>
                    </button>
                `).join('');
            },

            updateDisplay(text, isQR = false) {
                this.els.mainText.innerText = text;
                this.els.mainText.classList.remove('hidden');
                this.els.mainText.classList.add('visible');

                if (isQR) {
                    this.els.qrContainer.style.display = 'block';
                    this.els.qrWrapper.innerHTML = "";
                    const canvas = document.createElement('canvas');
                    this.els.qrWrapper.appendChild(canvas);
                    new QRious({ element: canvas, value: text, size: 256, level: 'H' });
                } else {
                    this.els.qrContainer.style.display = 'none';
                }
            },

            toggleQR() {
                if (this.els.qrContainer.style.display === 'block') {
                    this.closeQR();
                } else {
                    const content = this.els.input.value.trim() || this.els.mainText.innerText;
                    if (content) this.updateDisplay(content, true);
                }
            },

            closeQR() {
                this.els.qrContainer.style.display = 'none';
                this.els.input.focus(); // Restore focus to prevent toolbar collapse
            },

            toggleExpand() {
                state.isExpanded = !state.isExpanded;
                document.getElementById('control-panel').classList.toggle('expanded', state.isExpanded);
                this.els.input.setAttribute('placeholder', state.isExpanded ? "Modo Texto Rico..." : "Escreva... (Shift+Enter para Fila)");
                this.els.input.focus();
            },

            toggleSoundDrawer() {
                document.getElementById('sound-drawer').classList.toggle('open');
                document.getElementById('btn-sound-drawer').classList.toggle('active');
            },

            highlightSound(id, active) {
                const btn = document.getElementById(`btn-${id}`);
                if (btn) active ? btn.classList.add('sound-playing') : btn.classList.remove('sound-playing');
            },

            applyState() {
                document.body.setAttribute('data-mode', state.mode);
                this.els.root.setAttribute('data-theme', state.theme);

                const b = BRANDS[state.brand];
                if (b) {
                    const img = document.getElementById('app-logo');
                    img.src = state.theme === 'light' ? b.light : b.dark;
                    img.alt = b.name;
                }

                // Mark active menu items
                document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
                [`brand-${state.brand}`, `mode-${state.mode}`, `theme-${state.theme}`].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('active');
                });
            },

            updateQueueBadge() {
                const el = document.getElementById('nav-queue-count');
                const info = document.getElementById('queue-info-badge');
                if (state.queue.length > 0) {
                    el.innerText = state.queue.length;
                    el.classList.remove('hidden');
                    info.innerText = `${state.queue.length} em espera`;
                    info.classList.add('visible');
                    document.getElementById('nav-right').classList.add('visible');
                } else {
                    el.classList.add('hidden');
                    info.classList.remove('visible');
                    // Hide right arrow if no history forward and no queue
                    if (state.historyIndex >= state.history.length - 1) document.getElementById('nav-right').classList.remove('visible');
                }
            },

            navControls() {
                document.getElementById('nav-left').classList.toggle('visible', state.historyIndex > 0);
                const canFwd = state.historyIndex < state.history.length - 1 || state.queue.length > 0;
                document.getElementById('nav-right').classList.toggle('visible', canFwd);
            },

            confetti() {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#4facfe', '#00f2fe', '#ffffff'] });
            }
        };

        /*******************************************************
         * 5. FEATURES & LOGIC
         *******************************************************/
        const features = {
            timer: {
                setup: async () => {
                    if (state.timerInterval) {
                        clearInterval(state.timerInterval);
                        state.timerInterval = null;
                        document.getElementById('timer-overlay').style.display = 'none';
                        return;
                    }
                    const min = await modal.show({
                        title: 'Definir Timer',
                        html: '<input type="number" class="modal-input" placeholder="Minutos (ex: 5)" value="5" min="1">'
                    });
                    if (min) this.start(parseInt(min));
                },
                start(min) {
                    let time = min * 60;
                    const el = document.getElementById('timer-overlay');
                    el.style.display = 'block';
                    el.style.color = '';

                    const update = () => {
                        el.innerText = `${Math.floor(time / 60).toString().padStart(2, '0')}:${(time % 60).toString().padStart(2, '0')}`;
                    };
                    update();

                    state.timerInterval = setInterval(() => {
                        time--;
                        update();
                        if (time <= 0) {
                            clearInterval(state.timerInterval);
                            state.timerInterval = null;
                            el.style.color = '#ff4b4b';
                            AudioService.toggle('success');
                            ui.confetti();
                            setTimeout(() => { el.style.display = 'none'; }, 5000);
                        }
                    }, 1000);
                }
            }, this: null, // Hack to fix object literal implicit this in start() call above is messy, better define functions outside

            dice: {
                roll: () => {
                    ui.els.mainText.innerHTML = `
                        <div class="dice-wrapper">
                            <div id="dice-result" class="dice-result">...</div>
                            <div class="dice-visuals dice-shake"><span id="d1">⚀</span><span id="d2">⚀</span></div>
                        </div>`;
                    ui.updateDisplay(ui.els.mainText.innerText); // Force visibility logic
                    ui.els.mainText.classList.add('visible');
                    ui.els.qrContainer.style.display = 'none';
                    document.getElementById('scoreboard').style.display = 'none';

                    const chars = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
                    let rolls = 0;
                    const interval = setInterval(() => {
                        const v1 = Math.floor(Math.random() * 6);
                        const v2 = Math.floor(Math.random() * 6);
                        document.getElementById('d1').innerText = chars[v1];
                        document.getElementById('d2').innerText = chars[v2];
                        if (++rolls >= 20) {
                            clearInterval(interval);
                            document.querySelector('.dice-visuals').classList.remove('dice-shake');
                            const res = document.getElementById('dice-result');
                            res.innerText = (v1 + v2 + 2);
                            res.classList.add('show');
                            AudioService.toggle('success');
                            ui.confetti();
                        }
                    }, 80);
                }
            },

            picker: {
                setup: async () => {
                    const text = await modal.show({
                        title: 'Sorteio Aleatório',
                        html: '<textarea class="modal-input" placeholder="Nomes separados por vírgula" rows="4"></textarea>'
                    });
                    if (text) this.run(text.split(',').map(s => s.trim()).filter(Boolean));
                },
                run(names) {
                    if (names.length < 2) return;
                    ui.updateDisplay("Sorteando...");
                    let spins = 0;
                    const interval = setInterval(() => {
                        ui.els.mainText.innerText = names[Math.floor(Math.random() * names.length)];
                        if (++spins >= 30) {
                            clearInterval(interval);
                            AudioService.toggle('fanfare');
                            ui.confetti();
                        }
                    }, 100);
                }
            }, return: null, // Syntax fix helper

            score: {
                setup: async () => {
                    const sb = document.getElementById('scoreboard');
                    if (sb.style.display === 'flex') { sb.style.display = 'none'; return; }

                    const num = await modal.show({
                        title: 'Configurar Placar',
                        html: '<input type="number" class="modal-input" placeholder="Número de Equipas (2-6)" min="2" max="6" value="2">'
                    });
                    if (num) this.build(parseInt(num));
                },
                build(n) {
                    state.scores = {};
                    let html = '';
                    for (let i = 0; i < n; i++) {
                        const char = String.fromCharCode(65 + i);
                        state.scores[char] = 0;
                        html += `<div class="score-team" id="team-${char}" onmousedown="features.score.update('${char}', event)">
                                    <div class="score-val" id="score-${char}">0</div>
                                    <div class="score-label">Equipa ${char}</div>
                                 </div>`;
                    }
                    html += `<button class="tool-btn" onclick="features.score.checkWinner()" style="margin-left:10px; background:var(--glass-bg)">🏆</button>`;
                    const sb = document.getElementById('scoreboard');
                    sb.innerHTML = html;
                    sb.style.display = 'flex';
                },
                update(team, e) {
                    const delta = (e.shiftKey || e.button === 2) ? -1 : 1;
                    state.scores[team] = Math.max(0, state.scores[team] + delta);
                    document.getElementById(`score-${team}`).innerText = state.scores[team];
                    AudioService.toggle(delta > 0 ? 'pointUp' : 'pointDown');
                },
                checkWinner() {
                    let max = -1, winners = [];
                    Object.entries(state.scores).forEach(([t, s]) => {
                        if (s > max) { max = s; winners = [t]; }
                        else if (s === max) winners.push(t);
                    });
                    document.querySelectorAll('.score-team').forEach(el => el.classList.remove('winner-highlight'));
                    if (max > 0) {
                        winners.forEach(t => document.getElementById(`team-${t}`).classList.add('winner-highlight'));
                        AudioService.toggle('trophy');
                    }
                }
            }
        };

        // Fix logic binding
        Object.keys(features).forEach(k => {
            // Bind logic functions to their objects if needed, 
            // but simpler to just define them purely without 'this' dependency or correctly
        });

        // RE-DEFINING FEATURES WITH CORRECT CONTEXT
        // We override the previous definition to ensure 'this' correctness or use closure over 'features'
        // Correct feature bindings
        features.timer.setup = features.timer.setup.bind(features.timer);
        features.timer.start = features.timer.start.bind(features.timer);
        features.dice.roll = features.dice.roll.bind(features.dice);
        features.picker.setup = features.picker.setup.bind(features.picker);
        features.picker.run = features.picker.run.bind(features.picker);
        features.score.setup = features.score.setup.bind(features.score);
        features.score.build = features.score.build.bind(features.score);
        features.score.update = features.score.update.bind(features.score);
        features.score.checkWinner = features.score.checkWinner.bind(features.score);

        /*******************************************************
         * 6. MAIN CONTROLLER
         *******************************************************/
        const app = {
            setTheme(t) { state.theme = t; localStorage.setItem('qv_theme', t); ui.applyState(); },
            setMode(m) { state.mode = m; localStorage.setItem('qv_mode', m); ui.applyState(); },
            setBrand(b) { state.brand = b; localStorage.setItem('qv_brand', b); ui.applyState(); },

            processInput() {
                const val = ui.els.input.innerText.trim() ? ui.els.input.innerHTML : "";
                ui.els.input.innerHTML = "";
                if (val) this.showContent(val);
                ui.els.input.focus();
            },

            manualSubmit() { this.processInput(); },

            showContent(text) {
                // Determine if text handles HTML
                const isHtml = text.includes('<');
                const cleanText = isHtml ? text : text; // Simplify for now

                // Add to history
                if (state.history[state.history.length - 1] !== text) {
                    state.history.push(text);
                    state.historyIndex = state.history.length - 1;
                }
                ui.updateDisplay(text, false); // Pass false for isQR 
                ui.els.mainText.innerHTML = text; // Ensure HTML rendering
                ui.navControls();
            },

            addToQueue() {
                const val = ui.els.input.innerText.trim() ? ui.els.input.innerHTML : "";
                if (val) {
                    state.queue.push(val);
                    ui.els.input.innerHTML = "";
                    ui.updateQueueBadge();
                    AudioService.toggle('pointUp'); // Feedback sound
                }
            },

            navHistory(dir) {
                if (dir === 'back') {
                    if (state.historyIndex > 0) {
                        state.historyIndex--;
                        ui.updateDisplay(state.history[state.historyIndex]);
                    }
                } else {
                    if (state.queue.length > 0) {
                        const next = state.queue.shift();
                        ui.updateQueueBadge();
                        this.showContent(next);
                    } else if (state.historyIndex < state.history.length - 1) {
                        state.historyIndex++;
                        ui.updateDisplay(state.history[state.historyIndex]);
                    }
                }
                ui.navControls();
            },

            clear() {
                ui.els.mainText.innerText = "";
                ui.els.mainText.classList.remove('visible');
                ui.closeQR();
                document.getElementById('scoreboard').style.display = 'none';
                if (state.timerInterval) features.timer.setup(); // toggle off
            }
        };

        function toggleMenu(e) {
            e.stopPropagation();
            document.getElementById('logo-area').classList.toggle('active');
        }

        // INIT
        window.addEventListener('load', () => ui.init());

    </script>
</body>

</html>